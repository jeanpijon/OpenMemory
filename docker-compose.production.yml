services:
  postgres:
    image: pgvector/pgvector:pg16
    environment:
      POSTGRES_DB: openmemory
      POSTGRES_USER: openmemory_user
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U openmemory_user -d openmemory"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - openmemory

  ollama:
    image: ollama/ollama:latest
    volumes:
      - ollama_data:/root/.ollama
    restart: unless-stopped
    # GPU acceleration (uncomment if you have NVIDIA GPU):
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: all
    #           capabilities: [gpu]
    healthcheck:
      test: ["CMD", "ollama", "list"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - openmemory

  openmemory:
    build:
      context: ./packages/openmemory-js
      dockerfile: Dockerfile
    ports:
      - '${OM_PORT:-8080}:8080'
    environment:
      # Core Configuration
      - OM_PORT=${OM_PORT:-8080}
      - OM_MODE=${OM_MODE:-standard}
      - OM_TIER=deep
      - OM_API_KEY=${OM_API_KEY:-}

      # Embeddings - Ollama for DEEP tier
      - OM_EMBEDDINGS=ollama
      - OLLAMA_URL=http://ollama:11434
      - OM_EMBEDDING_FALLBACK=synthetic
      - OM_VEC_DIM=1024
      - OM_EMBED_MODE=simple

      # Postgres Backend
      - OM_METADATA_BACKEND=postgres
      - OM_PG_HOST=postgres
      - OM_PG_PORT=5432
      - OM_PG_DB=openmemory
      - OM_PG_USER=openmemory_user
      - OM_PG_PASSWORD=${POSTGRES_PASSWORD}
      - OM_PG_SCHEMA=public
      - OM_PG_TABLE=openmemory_memories
      - OM_PG_SSL=disable

      # Vector Backend (same Postgres)
      - OM_VECTOR_BACKEND=postgres
      - OM_VECTOR_TABLE=openmemory_vectors

      # Memory System
      - OM_MIN_SCORE=0.3
      - OM_MAX_PAYLOAD_SIZE=1000000
      - OM_DECAY_INTERVAL_MINUTES=120
      - OM_DECAY_THREADS=3
      - OM_DECAY_REINFORCE_ON_QUERY=true
      - OM_REGENERATION_ENABLED=true

      # Rate Limiting
      - OM_RATE_LIMIT_ENABLED=${OM_RATE_LIMIT_ENABLED:-true}
      - OM_RATE_LIMIT_WINDOW_MS=60000
      - OM_RATE_LIMIT_MAX_REQUESTS=100

      # Telemetry
      - OM_TELEMETRY=false
    volumes:
      - openmemory_data:/data
    depends_on:
      postgres:
        condition: service_healthy
      ollama:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ['CMD', 'wget', '--no-verbose', '--tries=1', '--spider', 'http://localhost:8080/health']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - openmemory

  dashboard:
    build:
      context: ./dashboard
      dockerfile: Dockerfile
      args:
        - NEXT_PUBLIC_API_URL=http://${DOMAIN:-localhost}:${OM_PORT:-8080}
        - NEXT_PUBLIC_API_KEY=
    ports:
      - '${DASHBOARD_PORT:-3000}:3000'
    environment:
      - NEXT_PUBLIC_API_URL=http://${DOMAIN:-localhost}:${OM_PORT:-8080}
      - NEXT_PUBLIC_API_KEY=
    depends_on:
      openmemory:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ['CMD', 'wget', '--no-verbose', '--tries=1', '--spider', 'http://localhost:3000']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - openmemory

volumes:
  postgres_data:
    driver: local
  ollama_data:
    driver: local
  openmemory_data:
    driver: local

networks:
  openmemory:
    driver: bridge
